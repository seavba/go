---
name: "workflow"

'on':
  push:
    branches:
      - main
      - master
    tags:
      - "*"
  pull_request:
    branches:
      - main

jobs:

  cd:
    name: "Deployment"
    runs-on: "ubuntu-latest"
  #  needs:
  #    - ci
    steps:
      - name: "Checkout Code"
        uses: "actions/checkout@v2"

      - name: Get vars values
        id: vars
        run: |
          echo "ecr_repo=$(grep -A1 ecr_repo ./iac/variables.tf | tail -n 1 | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "image_tag=$(grep -A1 image_tag ./iac/variables.tf | tail -n 1 | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "service=$(grep -A1 aws_ecs_service ./iac/ecs.tf | tail -n 1 | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "cluster=$(grep -A1 'resource "aws_ecs_cluster"' ./iac/ecs.tf | tail -n 1  | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "region=$(grep -A1 aws_region ./iac/variables.tf | tail -n 1 | awk -F '\"' '{print $2}')" >> $GITHUB_ENV
          echo "domain=$(grep -A1 domain_name ./iac/variables.tf | tail -n 1 | awk -F '\"' '{print $2}')" >> $GITHUB_ENV

      - name: Print values
        id: host
        run: |
          echo "$domain"
          echo $domain
          echo "${{ env.domain }}"
          echo ${{ env.domain }}
          sed -i "s/localhost/${{ env.domain }}/g" app/static/index.html
          cat app/static/index.html
